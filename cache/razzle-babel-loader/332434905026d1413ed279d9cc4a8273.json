{"ast":null,"code":"import { selectSeasonPassPriceFormatted } from './../../products/selectors';\nimport { tokenRefreshTokenRequestedEvent } from './../../../userSecurity/token/events';\nimport { ofType } from 'redux-observable';\nimport { from, of } from 'rxjs';\nimport { exhaustMap, catchError } from 'rxjs/operators';\nimport { purchaseTagErroredEvent, purchaseTagReceivedEvent } from '../events';\nimport { postPurchaseProduct } from '../api/postPurchaseProduct';\nimport * as eventTypes from '../eventTypes';\nimport Notifications from 'react-notification-system-redux';\nimport { tagsSaveTagEvent } from '../../../content/tags/events';\nimport { selectTag } from '../../../content/tags/selectors';\nimport { selectSelectedStripeProductId } from '../selectors';\n\nvar getSuccessNotification = function getSuccessNotification() {\n  return Notifications.success({\n    title: 'Payment succeeded',\n    message: 'Enjoy your purchase',\n    position: 'tc',\n    autoDismiss: 10,\n    action: {\n      label: 'Close',\n      callback: function callback() {\n        return console.log('Notification closed');\n      }\n    }\n  });\n};\n\nvar getErrorNotification = function getErrorNotification(error) {\n  return Notifications.error({\n    title: 'Payment failed',\n    message: \"An error occurred \".concat(error),\n    position: 'tc',\n    autoDismiss: 10,\n    action: {\n      label: 'Close',\n      callback: function callback() {\n        return console.log('Notification closed');\n      }\n    }\n  });\n};\n\nvar purchaseTagRequestedEpic = function purchaseTagRequestedEpic(action$, state$) {\n  return action$.pipe(ofType(eventTypes.PAYMENTS_PURCHASE_TAG_REQUESTED), exhaustMap(function () {\n    return from(postPurchaseProduct(selectSelectedStripeProductId(state$.value), '', {\n      _id: 1,\n      token: state$.value.payments.paymentDetails.token.id,\n      brand: state$.value.payments.paymentDetails.token.card.brand,\n      last4: state$.value.payments.paymentDetails.token.card.last4,\n      expiry_year: state$.value.payments.paymentDetails.token.card.exp_year,\n      expiry_month: state$.value.payments.paymentDetails.token.card.exp_month\n    })).pipe(exhaustMap(function (apiResponse) {\n      if (apiResponse.is_success) {\n        var tagId = state$.value.payments.purchase.tagId;\n        var tag = selectTag(state$.value, tagId);\n        var seasonPassPriceFormatted = selectSeasonPassPriceFormatted(state$.value);\n\n        try {\n          var data = {\n            'event': 'transaction',\n            'ecommerce': {\n              'purchase': {\n                'actionField': {\n                  'id': tag === null || tag === void 0 ? void 0 : tag.stripeProductId,\n                  'affiliation': 'Tag',\n                  'revenue': seasonPassPriceFormatted,\n                  'tax': '$0.00',\n                  'shipping': '$0.00',\n                  'coupon': ''\n                },\n                'products': [{\n                  'name': tag === null || tag === void 0 ? void 0 : tag.name,\n                  'id': tag === null || tag === void 0 ? void 0 : tag.id,\n                  'price': seasonPassPriceFormatted,\n                  'brand': '',\n                  'category': '',\n                  'variant': '',\n                  'quantity': 1,\n                  'coupon': ''\n                }]\n              }\n            }\n          };\n          window.dataLayer.push(data);\n        } catch (err) {\n          console.log('purchaseTagRequestedEpic dataLayer push error', err);\n        }\n\n        return of(tokenRefreshTokenRequestedEvent(), purchaseTagReceivedEvent((tag === null || tag === void 0 ? void 0 : tag.path) || ''), getSuccessNotification(), tagsSaveTagEvent(state$.value.payments.purchase.tagId || '')); // todo: saved already this will unsave\n      } else {\n        return of(purchaseTagErroredEvent(apiResponse.data), getErrorNotification(apiResponse.data));\n      }\n    }), catchError(function () {\n      return of(purchaseTagErroredEvent({\n        id: undefined,\n        error: 'Network error',\n        errorDescription: 'Check your internet connection'\n      }));\n    }));\n  }));\n};\n\nexport default [purchaseTagRequestedEpic];","map":{"version":3,"sources":["/Users/ognjen/Desktop/with-typescript/src/services/payments/purchase/epics/purchaseTagRequestedEpic.ts"],"names":["selectSeasonPassPriceFormatted","tokenRefreshTokenRequestedEvent","ofType","from","of","exhaustMap","catchError","purchaseTagErroredEvent","purchaseTagReceivedEvent","postPurchaseProduct","eventTypes","Notifications","tagsSaveTagEvent","selectTag","selectSelectedStripeProductId","getSuccessNotification","success","title","message","position","autoDismiss","action","label","callback","console","log","getErrorNotification","error","purchaseTagRequestedEpic","action$","state$","pipe","PAYMENTS_PURCHASE_TAG_REQUESTED","value","_id","token","payments","paymentDetails","id","brand","card","last4","expiry_year","exp_year","expiry_month","exp_month","apiResponse","is_success","tagId","purchase","tag","seasonPassPriceFormatted","data","stripeProductId","name","window","dataLayer","push","err","path","undefined","errorDescription"],"mappings":"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","sourcesContent":["import { selectSeasonPassPriceFormatted } from './../../products/selectors';\nimport { tokenRefreshTokenRequestedEvent } from './../../../userSecurity/token/events';\nimport { Epic, ofType } from 'redux-observable'\nimport { from, of } from 'rxjs'\nimport { exhaustMap, catchError } from 'rxjs/operators'\nimport { purchaseTagErroredEvent, purchaseTagReceivedEvent } from '../events'\nimport { RootState } from '../../../RootState'\nimport { postPurchaseProduct } from '../api/postPurchaseProduct'\nimport * as eventTypes from '../eventTypes'\nimport Notifications from 'react-notification-system-redux'\nimport { tagsSaveTagEvent } from '../../../content/tags/events'\nimport { selectTag } from '../../../content/tags/selectors'\nimport { selectSelectedStripeProductId } from '../selectors'\n\nconst getSuccessNotification = () => {\n  return Notifications.success(\n    {\n      title: 'Payment succeeded',\n      message: 'Enjoy your purchase',\n      position: 'tc',\n      autoDismiss: 10,\n      action: {\n        label: 'Close',\n        callback: () => console.log('Notification closed')\n      }\n    }\n  )\n}\n\nconst getErrorNotification = (error: any) => {\n  return Notifications.error(\n    {\n      title: 'Payment failed',\n      message: `An error occurred ${error}`,\n      position: 'tc',\n      autoDismiss: 10,\n      action: {\n        label: 'Close',\n        callback: () => console.log('Notification closed')\n      }\n    }\n  )\n}\n\nconst purchaseTagRequestedEpic: Epic<any, any, RootState> = (action$, state$) =>\n  action$.pipe(\n    ofType(eventTypes.PAYMENTS_PURCHASE_TAG_REQUESTED),\n    exhaustMap(() =>\n      from(postPurchaseProduct(selectSelectedStripeProductId(state$.value), '', {\n        _id: 1,\n        token: state$.value.payments.paymentDetails.token.id,\n        brand: state$.value.payments.paymentDetails.token.card.brand,\n        last4: state$.value.payments.paymentDetails.token.card.last4,\n        expiry_year: state$.value.payments.paymentDetails.token.card.exp_year,\n        expiry_month: state$.value.payments.paymentDetails.token.card.exp_month\n      })).pipe(\n        exhaustMap(apiResponse => {\n          if (apiResponse.is_success) {\n            const tagId = state$.value.payments.purchase.tagId\n            const tag = selectTag(state$.value, tagId)\n\n            const seasonPassPriceFormatted = selectSeasonPassPriceFormatted(state$.value);\n            try {\n              let data = {\n                'event': 'transaction',\n                'ecommerce': {\n                  'purchase': {\n                    'actionField': {\n                      'id': tag?.stripeProductId,\n                      'affiliation': 'Tag',\n                      'revenue': seasonPassPriceFormatted,\n                      'tax': '$0.00',\n                      'shipping': '$0.00',\n                      'coupon': ''\n                    },\n                    'products': [{\n                      'name': tag?.name,\n                      'id': tag?.id,\n                      'price': seasonPassPriceFormatted,\n                      'brand': '',\n                      'category': '',\n                      'variant': '',\n                      'quantity': 1,\n                      'coupon': ''\n                    }]\n                  }\n                }\n              };\n              (window as any).dataLayer.push(data);\n            } catch (err) {\n              console.log('purchaseTagRequestedEpic dataLayer push error', err);\n            }\n\n            return of(tokenRefreshTokenRequestedEvent(), purchaseTagReceivedEvent(tag?.path || ''), getSuccessNotification(), tagsSaveTagEvent(state$.value.payments.purchase.tagId || '')) // todo: saved already this will unsave\n          } else {\n            return of(purchaseTagErroredEvent(apiResponse.data), getErrorNotification(apiResponse.data))\n          }\n        }),\n        catchError(() => of(purchaseTagErroredEvent({\n          id: undefined,\n          error: 'Network error',\n          errorDescription: 'Check your internet connection'\n        })))\n      )\n    )\n  )\n\nexport default [purchaseTagRequestedEpic]\n"]},"metadata":{},"sourceType":"module"}